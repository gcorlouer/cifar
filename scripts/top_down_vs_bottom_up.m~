%% Compare top down vs bottom up GC
% In this script we compare top down (F -> R) vs bottom-up (R -> F) GC 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Input:  -Subject and condition-specific mutltirial HFA #X=(n x m x N)
% Output: -3x1 Z-score testing stochastic dominance of top down vs
%         bottom up GC in each condition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Algorithm: 
%  for c in conditions, for s in subjects
%     R_idx = gc_input.indices('R')
%     F_idx = gc_input.indices('F')  
%     F = ts_to_single_pcgc(X, args);
%     F_td{ipair, s} = {F(i,j), for (i,j) in (R_idx, F_idx)} %Not good yet
%     F_bu{ipair, s} = {F(i,j), for (i,j) in (F_idx, R_idx)}
%  F_td = flatten(F_td{c,s});
%  F_bu = flatten(F_bu{c,s});
%  z = wilcox(F_td, F_bu); #z = ncdt x 1
%%

input_parameters;
ncdt = length(conditions);
nsub = length(cohort);
% Cross subjects top down and bottom up GC
F_td = cell(nsub,1);
F_bu = cell(nsub,1);

Zscore = struct;
%% Estimate group td vs bu by pooling td and bu
for c=1:ncdt
    condition = conditions{c};
    for s=1:nsub
        subject_id = cohort{s};
        gc_input = read_cdt_time_series('datadir', datadir, 'subject', subject_id,...
            'condition',condition, 'suffix', suffix);
        X = gc_input.X;
        indices = gc_input.indices;
        F = ts_to_single_pair_unconditional_gc(X, 'morder',morder, 'regmode', regmode);
        R_idx = indices.('R');
        F_idx = indices.('F');
        F_t = F(R_idx, F_idx,:);
        F_b = F(F_idx, R_idx,:);
        F_t = reshape(F_t, numel(F_t),1);
        F_b = reshape(F_b, numel(F_b),1);
        
        F_td{s} = F_t;
        F_bu{s} = F_b;
    end
    z = mann_whitney_group(F_td,F_bu);
    zcrit = sqrt(2)*erfcinv(alpha);
    % Compute pcrit, zcrit, significance.
    Zscore.(condition).val = z;
    Zscore.(condition).zcrit = zcrit;
end

%% Estimate pairwise top down vs bottom up

for s=1:nsub
    for c=1:ncdt
        subject_id = cohort{s};
        gc_input = read_cdt_time_series('datadir', datadir, 'subject', subject_id,...
            'condition',condition, 'suffix', suffix);
        X = gc_input.X;
        indices = gc_input.indices;
        F = ts_to_single_pair_unconditional_gc(X, 'morder',morder, 'regmode', regmode);
        R_idx = indices.('R');
        F_idx = indices.('F');
        F_t = F(R_idx, F_idx,:);
        F_b = F(F_idx, R_idx,:);
        % Loop over pairs of retinotopic and face channels
        nR = length(R_idx);
        nF = length(F_idx);
        z = zeros(nR,nF);
        for i=1:nR
            for j =1:nF
                z(i,j) = mann_whitney(F_t(i,j,:),F_b(j,i,:));
            end
        end
        pvals = erfc(abs(z)/sqrt(2));
        [sigs,pcrit] = significance(pvals,alpha,mhtc);
        zcrit = sqrt(2)*erfcinv(pcrit);
        pZscore.(subject
    end
end

        





